<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HavacÄ±lÄ±k & AOF AkÄ±llÄ± SÄ±nav Sistemi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f1f5f9;
            --card: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: #0f172a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            background: var(--card);
            width: 100%;
            max-width: 900px;
            min-height: 700px;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* --- SAYFA YAPISI --- */
        .page {
            display: none;
            flex-grow: 1;
            padding: 40px;
            animation: fadeIn 0.4s ease-out;
            flex-direction: column;
        }
        .page.active { display: flex; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- LOGIN --- */
        .login-wrapper {
            margin: auto;
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        .login-input {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            background: #f8fafc;
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
            transition: 0.3s;
        }
        .login-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* --- BUTONLAR --- */
        .btn {
            background: white;
            border: 2px solid #e2e8f0;
            color: #334155;
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: var(--primary); color: white; border: none; }
        .btn-primary:hover { background: var(--primary-dark); color: white; }
        
        .btn-danger { border-color: #fecaca; color: var(--danger); }
        .btn-danger:hover { background: #fef2f2; border-color: var(--danger); }

        /* --- MENÃœ GRID --- */
        .grid-menu {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stats-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .stats-title { font-size: 0.9rem; color: var(--secondary); margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- QUIZ EKRANI --- */
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 20px; border-bottom: 2px solid #f1f5f9; margin-bottom: 25px;
        }
        .progress-bar-container {
            flex-grow: 1; margin: 0 20px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }
        
        .question-text { font-size: 1.4rem; font-weight: 700; color: #1e293b; margin-bottom: 25px; line-height: 1.5; }
        
        .option-card {
            padding: 20px; border: 2px solid #f1f5f9; border-radius: 12px;
            cursor: pointer; transition: 0.2s; font-size: 1.1rem; margin-bottom: 12px;
            background: white; color: #334155; position: relative;
        }
        .option-card:hover { border-color: #94a3b8; background: #f8fafc; }
        
        .option-card.correct { background: #dcfce7; border-color: var(--success); color: #14532d; }
        .option-card.incorrect { background: #fee2e2; border-color: var(--danger); color: #7f1d1d; }
        .option-card.hint { border-color: var(--success); background: #f0fdf4; color: var(--success); font-weight: 600; }

        /* Navigasyon ButonlarÄ± */
        .nav-area {
            display: flex; justify-content: space-between; gap: 15px;
            margin-top: 30px; padding-top: 20px; border-top: 2px solid #f1f5f9;
        }
        .nav-btn {
            flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem;
        }
        .nav-prev { background: #e2e8f0; color: #475569; }
        .nav-next { background: var(--primary); color: white; }
        .nav-prev:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Switch */
        .switch-container { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; font-weight: 500; color: var(--secondary); }
        .switch { position: relative; display: inline-block; width: 48px; height: 26px; }
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0; background-color: #cbd5e1; transition:.3s; border-radius: 34px; }
        .slider:before { position: absolute; content:""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition:.3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* HÄ±zlÄ± EriÅŸim */
        .dots-grid {
            display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
            max-height: 100px; overflow-y: auto; margin-top: 20px;
        }
        .dot {
            width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; background: #f1f5f9; color: #64748b; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent;
        }
        .dot.current { border-color: var(--primary); color: var(--primary); font-weight: bold; background: white; }
        .dot.correct { background: var(--success); color: white; }
        .dot.incorrect { background: var(--danger); color: white; }

        /* SonuÃ§ */
        .score-circle {
            width: 160px; height: 160px; border-radius: 50%;
            background: var(--primary); color: white;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 20px; font-size: 2.8rem; font-weight: 800; /* Font kÃ¼Ã§Ã¼ltÃ¼ldÃ¼ */
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.3);
        }

        /* KullanÄ±cÄ± Header */
        .user-header {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            display: flex; align-items: center; gap: 15px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(4px);
            padding: 8px 16px; border-radius: 20px; border: 1px solid #e2e8f0;
        }
        .logout-link { color: var(--danger); font-size: 0.85rem; cursor: pointer; text-decoration: underline; }

        /* Hata Kategorileri */
        .mistake-cat {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
            border: 1px solid transparent;
        }
        .mistake-cat:hover { transform: translateX(5px); }
        .cat-critical { background: #fef2f2; color: #991b1b; border-color: #fecaca; }
        .cat-warning { background: #fffbeb; color: #92400e; border-color: #fde68a; }
        .cat-info { background: #eff6ff; color: #1e40af; border-color: #bfdbfe; }
        .cat-badge { font-weight: bold; padding: 4px 8px; border-radius: 12px; background: rgba(255,255,255,0.6); font-size: 0.8rem; }

    </style>
</head>
<body>

<div class="app-container">
    
    <div id="user-info-panel" class="user-header" style="display: none;">
        <span style="font-weight: 600; color: #334155;">ğŸ‘¤ <span id="display-username">Misafir</span></span>
        <span class="logout-link" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</span>
    </div>

    <div id="page-login" class="page active">
        <div class="login-wrapper">
            <h1 style="color: var(--primary); margin-bottom: 10px;">AkÄ±llÄ± SÄ±nav Sistemi</h1>
            <p style="color: var(--secondary); margin-bottom: 30px;">HavacÄ±lÄ±k & AOF Ã‡alÄ±ÅŸma Platformu</p>
            <input type="text" id="username-input" class="login-input" placeholder="AdÄ±nÄ±z / KullanÄ±cÄ± AdÄ±">
            <button class="btn btn-primary" style="width:100%" onclick="login()">ğŸš€ BaÅŸla</button>
        </div>
    </div>

    <div id="page-menu" class="page">
        <h2 style="color: #1e293b; margin-bottom: 20px;">Soru HavuzlarÄ±</h2>
        
        <div class="grid-menu">
            <button class="btn" onclick="startQuiz('temel')">âœˆï¸ Temel Sorular (102)</button>
            <button class="btn" onclick="startQuiz('cikmis')">ğŸ“œ Ã‡Ä±kmÄ±ÅŸ Sorular (48)</button>
            <button class="btn" onclick="startQuiz('ai')">ğŸ¤– AI Ã–ÄŸretici (40)</button>
        </div>

        <button class="btn btn-primary" style="margin-bottom: 25px;" onclick="showPage('page-aof')">
            ğŸ“š AOF ModÃ¼lÃ¼ (Deneme & Final)
        </button>
        
        <div class="stats-card">
            <div class="stats-title">ğŸ“Š Performans Analizi & Hatalar</div>
            <p style="font-size: 0.9rem; color: #64748b; margin-bottom: 15px;">YanlÄ±ÅŸ yaptÄ±ÄŸÄ±n sorular baÅŸarÄ± oranÄ±na gÃ¶re sÄ±nÄ±flandÄ±rÄ±lÄ±r.</p>
            
            <div id="mistake-categories">
                <div style="text-align: center; color: #94a3b8; padding: 10px;">HenÃ¼z hata kaydÄ± yok.</div>
            </div>
        </div>

        <button class="btn" style="width: 100%;" onclick="startQuiz('mix')">ğŸ”€ KarÄ±ÅŸÄ±k Maraton (TÃ¼mÃ¼)</button>
    </div>

    <div id="page-aof" class="page">
        <button class="btn" style="width: auto; align-self: flex-start; padding: 8px 16px; margin-bottom: 20px;" onclick="showPage('page-menu')">â† Geri</button>
        <h2 style="margin-bottom: 20px;">AOF SÄ±navlarÄ±</h2>
        
        <div class="grid-menu">
            <button class="btn" onclick="startQuiz('aof_deneme1')">ğŸ“ Deneme 1</button>
            <button class="btn" onclick="startQuiz('aof_deneme2')">ğŸ“ Deneme 2</button>
            <button class="btn" onclick="startQuiz('aof_final1')">ğŸ“ Final 1</button>
            <button class="btn" onclick="startQuiz('aof_final2')">ğŸ“ Final 2</button>
        </div>
        <button class="btn btn-primary" style="margin-top: 15px;" onclick="startQuiz('aof_mix')">ğŸ”€ KarÄ±ÅŸÄ±k AOF Testi</button>
    </div>

    <div id="page-quiz" class="page">
        <div class="quiz-header">
            <button onclick="endQuiz()" style="background:none; border:none; color:#94a3b8; font-weight:bold; cursor:pointer;">âœ• Ã‡Ä±k</button>
            <div class="progress-bar-container">
                <div class="progress-bar" id="q-bar"></div>
            </div>
            <div class="switch-container">
                Otomatik
                <label class="switch">
                    <input type="checkbox" id="auto-next" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div style="display:flex; justify-content: space-between; margin-bottom:10px; font-size:0.9rem; color:var(--secondary);">
            <span id="q-counter">Soru 1</span>
            <span id="q-category">Genel</span>
        </div>

        <div class="question-text" id="q-text">Soru yÃ¼kleniyor...</div>
        <div id="q-options"></div>
        
        <div class="nav-area">
            <button class="nav-btn nav-prev" id="btn-prev" onclick="prevQuestion()">â† Ã–nceki</button>
            <button class="nav-btn nav-next" id="btn-next" onclick="nextQuestion()">Sonraki â†’</button>
        </div>

        <div class="dots-grid" id="q-dots"></div>
    </div>

    <div id="page-result" class="page">
        <div style="margin: auto; text-align: center;">
            <div class="score-circle">
                <span id="res-score">%0</span>
                <span class="score-label">BAÅARI</span>
            </div>
            <h2 id="res-msg">SonuÃ§</h2>
            <p style="color: #64748b; margin-bottom: 30px;">Hatalar analiz sistemine kaydedildi.</p>
            
            <div class="grid-menu" style="max-width: 600px; margin: 0 auto;">
                <button class="btn" onclick="showPage('page-menu')">ğŸ  Ana MenÃ¼</button>
                <button class="btn btn-primary" onclick="restartQuiz()">ğŸ”„ Testi Tekrar Ã‡Ã¶z</button>
            </div>
            <button id="btn-retry-session-mistakes" class="btn btn-danger" style="width: 100%; max-width: 600px; margin: 10px auto; display:none;" onclick="retrySessionMistakes()">
                âš ï¸ Sadece Bu Testteki YanlÄ±ÅŸlarÄ± Ã‡Ã¶z
            </button>
        </div>
    </div>

</div>

<script>
    /* --- 1. VERÄ° HAVUZLARI --- */
    // Buraya Ã¶nceki 190 sorunun tamamÄ±nÄ± ve AOF sorularÄ±nÄ± ekleyeceksiniz.
    
    // Ã–RNEK VERÄ° (Siz burayÄ± dolduracaksÄ±nÄ±z)
    const basicQuestions = [
        { q: "DÃ¼nyadaki tÃ¼m havacÄ±lÄ±k faaliyetleri temelde hangi iki ana gruba ayrÄ±lÄ±r?", options: ["Sadece sivil havacÄ±lÄ±k", "Sivil havacÄ±lÄ±k ve Devlet havacÄ±lÄ±ÄŸÄ±", "UluslararasÄ± ve Ulusal havacÄ±lÄ±k", "Askeri ve Ticari havacÄ±lÄ±k"], answer: "Sivil havacÄ±lÄ±k ve Devlet havacÄ±lÄ±ÄŸÄ±" },
        { q: "Sivil havacÄ±lÄ±k faaliyetlerinin temel amacÄ± aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["Sadece hÄ±zlÄ± ulaÅŸÄ±m saÄŸlamak", "UÃ§ak Ã¼retimini artÄ±rmak", "Ä°nsanlarÄ±n emniyetli, ekonomik, hÄ±zlÄ± ve Ã§evreye duyarlÄ± bir ÅŸekilde ulaÅŸÄ±mÄ±", "AskerÃ® operasyonlarÄ± desteklemek"], answer: "Ä°nsanlarÄ±n emniyetli, ekonomik, hÄ±zlÄ± ve Ã§evreye duyarlÄ± bir ÅŸekilde ulaÅŸÄ±mÄ±" },
        { q: "Havadan aÄŸÄ±r, motor gÃ¼cÃ¼yle seyreden ve aerodinamik kuvvetlerden destek alan sabit kanatlÄ± hava aracÄ± nedir?", options: ["Balon", "Helikopter", "PlanÃ¶r", "UÃ§ak"], answer: "UÃ§ak" },
        { q: "ICAO'nun tam aÃ§Ä±lÄ±mÄ± nedir?", options: ["International Civil Aviation Organization", "International Cargo Air Organization", "Industrial Civil Air Operations", "International Control of Air Operations"], answer: "International Civil Aviation Organization" },
        { q: "1 foot kaÃ§ metredir?", options: ["0,25", "0,3048", "1,85", "3,048"], answer: "0,3048" }
    ];
    
    // Ã‡Ä±kmÄ±ÅŸ ve AI sorularÄ±nÄ± Ã¶nceki koddan buraya kopyalayabilirsiniz.
    const pastQuestions = [
        { q: "ICAO KodlarÄ±na GÃ¶re HavaalanlarÄ± Ã¼lkemizde hangi harf ile baÅŸlamaktadÄ±r?", options: ["L", "T", "E", "A"], answer: "L" },
        { q: "BakÄ±mÄ±n yapÄ±ldÄ±ÄŸÄ± yere gÃ¶re bakÄ±m tÃ¼rleri nelerdir?", options: ["Hat BakÄ±mÄ±, Ãœs BakÄ±mÄ±", "Ã–nleyici, DÃ¼zeltici", "PlanlÄ±, PlansÄ±z", "AÄŸÄ±r, Hafif"], answer: "Hat BakÄ±mÄ±, Ãœs BakÄ±mÄ±" }
    ];

    const aiQuestions = [
        { q: "ICAO Annex 17 (Ek-17) hangi konuyu dÃ¼zenler?", options: ["Hava Trafik", "GÃ¼venlik (Security)", "Ã‡evre", "Arama Kurtarma"], answer: "GÃ¼venlik (Security)" },
        { q: "CORSIA programÄ±nÄ±n 'Karbon NÃ¶tr BÃ¼yÃ¼me' hedefi hangi yÄ±ldan itibaren geÃ§erlidir?", options: ["2000", "2010", "2020", "2050"], answer: "2020" }
    ];

    // AOF SorularÄ± (Buraya word dosyasÄ±ndaki sorularÄ± ekleyin)
    const aofData = {
        deneme1: [ { q: "AOF Deneme 1 Ã–rnek Soru?", options: ["A", "B", "C", "D"], answer: "A" } ],
        deneme2: [ { q: "AOF Deneme 2 Ã–rnek Soru?", options: ["X", "Y", "Z", "Q"], answer: "X" } ],
        final1: [ { q: "AOF Final 1 Ã–rnek Soru?", options: ["1", "2", "3", "4"], answer: "1" } ],
        final2: [ { q: "AOF Final 2 Ã–rnek Soru?", options: ["Evet", "HayÄ±r"], answer: "Evet" } ]
    };


    /* --- 2. SÄ°STEM MANTIÄI --- */
    let currentUser = null;
    let currentPool = [];
    let currentIndex = 0;
    let userAnswers = []; // O anki session cevaplarÄ±

    // BaÅŸlangÄ±Ã§
    window.onload = function() {
        const savedUser = localStorage.getItem('havacilik_user');
        if (savedUser) {
            currentUser = savedUser;
            updateUIUser();
            showPage('page-menu');
            renderMistakeMenu();
        } else {
            showPage('page-login');
        }
    };

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.getElementById('user-info-panel').style.display = (id === 'page-login') ? 'none' : 'flex';
        if(id === 'page-menu') renderMistakeMenu();
    }

    // Login / Logout
    function login() {
        const val = document.getElementById('username-input').value.trim();
        if(!val) return alert("Ä°sim giriniz.");
        currentUser = val;
        localStorage.setItem('havacilik_user', val);
        
        // VeritabanÄ± baÅŸlat
        let db = getDB();
        if(!db[currentUser]) {
            db[currentUser] = { stats: {} }; // Soru bazlÄ± istatistikler
            saveDB(db);
        }
        
        updateUIUser();
        showPage('page-menu');
    }

    function logout() {
        if(confirm("Ã‡Ä±kÄ±ÅŸ yapmak istiyor musunuz?")) {
            localStorage.removeItem('havacilik_user');
            currentUser = null;
            showPage('page-login');
        }
    }

    function updateUIUser() {
        document.getElementById('display-username').textContent = currentUser;
    }

    // VeritabanÄ±
    function getDB() { return JSON.parse(localStorage.getItem('havacilik_db_v2') || '{}'); }
    function saveDB(data) { localStorage.setItem('havacilik_db_v2', JSON.stringify(data)); }

    // Ä°statistik GÃ¼ncelleme (Soruyu Ã§Ã¶zÃ¼nce Ã§alÄ±ÅŸÄ±r)
    function updateQuestionStats(question, isCorrect) {
        let db = getDB();
        if (!db[currentUser].stats) db[currentUser].stats = {};
        
        // Sorunun metni unique ID olarak kullanÄ±lÄ±r
        const qKey = question.q; 
        
        if (!db[currentUser].stats[qKey]) {
            db[currentUser].stats[qKey] = { total: 0, correct: 0, wrong: 0, lastCorrect: false, questionObj: question };
        }
        
        let stat = db[currentUser].stats[qKey];
        stat.total++;
        if (isCorrect) {
            stat.correct++;
            stat.lastCorrect = true;
        } else {
            stat.wrong++;
            stat.lastCorrect = false;
        }
        stat.questionObj = question; // Objenin gÃ¼ncel halini sakla
        
        saveDB(db);
    }

    // Hata Kategorilerini Hesapla ve MenÃ¼yÃ¼ Ã‡iz
    function getMistakeCategories() {
        let db = getDB();
        let stats = db[currentUser] ? db[currentUser].stats : {};
        let critical = [], warning = [], info = [];

        Object.values(stats).forEach(item => {
            // Sadece en az 1 kez yanlÄ±ÅŸ yapÄ±lmÄ±ÅŸ sorularÄ± al
            if (item.wrong > 0) {
                let successRate = (item.correct / item.total) * 100;
                
                // Kategorize Et
                if (successRate < 50) critical.push(item.questionObj);      // %0 - %49 (En Ã‡ok YanlÄ±ÅŸ)
                else if (successRate < 80) warning.push(item.questionObj);  // %50 - %79 (SÄ±k Hata)
                else info.push(item.questionObj);                           // %80+ (Nadir Hata)
            }
        });

        return { critical, warning, info };
    }

    function renderMistakeMenu() {
        const cats = getMistakeCategories();
        const container = document.getElementById('mistake-categories');
        container.innerHTML = '';

        if (cats.critical.length === 0 && cats.warning.length === 0 && cats.info.length === 0) {
            container.innerHTML = `<div style="text-align: center; color: #94a3b8; padding: 10px;">Harika! KayÄ±tlÄ± hata yok.</div>`;
            return;
        }

        if (cats.critical.length > 0) {
            container.innerHTML += `
            <div class="mistake-cat cat-critical" onclick="startMistakeQuiz('critical')">
                <span>ğŸ”´ En Ã‡ok YanlÄ±ÅŸ YapÄ±lanlar (%0-%49)</span>
                <span class="cat-badge">${cats.critical.length} Soru</span>
            </div>`;
        }
        if (cats.warning.length > 0) {
            container.innerHTML += `
            <div class="mistake-cat cat-warning" onclick="startMistakeQuiz('warning')">
                <span>ğŸŸ  SÄ±k Hata YapÄ±lanlar (%50-%79)</span>
                <span class="cat-badge">${cats.warning.length} Soru</span>
            </div>`;
        }
        if (cats.info.length > 0) {
            container.innerHTML += `
            <div class="mistake-cat cat-info" onclick="startMistakeQuiz('info')">
                <span>ğŸ”µ Nadir Hatalar (%80+)</span>
                <span class="cat-badge">${cats.info.length} Soru</span>
            </div>`;
        }
    }

    // Quiz BaÅŸlatÄ±cÄ±lar
    function startQuiz(type) {
        currentPool = [];
        if (type === 'temel') currentPool = [...basicQuestions];
        else if (type === 'cikmis') currentPool = [...pastQuestions];
        else if (type === 'ai') currentPool = [...aiQuestions];
        else if (type === 'mix') currentPool = [...basicQuestions, ...pastQuestions, ...aiQuestions];
        else if (type === 'aof_deneme1') currentPool = [...aofData.deneme1];
        else if (type === 'aof_deneme2') currentPool = [...aofData.deneme2];
        else if (type === 'aof_final1') currentPool = [...aofData.final1];
        else if (type === 'aof_final2') currentPool = [...aofData.final2];
        else if (type === 'aof_mix') currentPool = [...aofData.deneme1, ...aofData.deneme2, ...aofData.final1, ...aofData.final2];

        if (currentPool.length === 0) return alert("Bu kategoride soru bulunamadÄ±.");

        // KarÄ±ÅŸtÄ±r
        currentPool.sort(() => Math.random() - 0.5);
        
        initQuizUI();
    }

    function startMistakeQuiz(category) {
        const cats = getMistakeCategories();
        if (category === 'critical') currentPool = cats.critical;
        else if (category === 'warning') currentPool = cats.warning;
        else if (category === 'info') currentPool = cats.info;
        
        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

    function initQuizUI() {
        currentIndex = 0;
        userAnswers = new Array(currentPool.length).fill(null);
        showPage('page-quiz');
        loadQuestion();
        renderDots();
        updateProgressBar();
    }

    // Soru YÃ¼kleme
    function loadQuestion() {
        const q = currentPool[currentIndex];
        document.getElementById('q-text').textContent = q.q;
        document.getElementById('q-counter').textContent = `Soru ${currentIndex + 1} / ${currentPool.length}`;
        document.getElementById('q-category').textContent = "Test Modu";

        const optsDiv = document.getElementById('q-options');
        optsDiv.innerHTML = '';

        q.options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'option-card';
            btn.textContent = opt;
            btn.onclick = () => handleAnswer(opt, btn);
            optsDiv.appendChild(btn);
        });

        // Varsa eski cevabÄ± yÃ¼kle
        if (userAnswers[currentIndex]) restoreState();

        // Buton durumlarÄ±
        document.getElementById('btn-prev').disabled = (currentIndex === 0);
        document.getElementById('btn-next').textContent = (currentIndex === currentPool.length - 1) ? 'Bitir' : 'Sonraki â†’';
        
        updateProgressBar();
        updateDots();
    }

    function handleAnswer(selected, btn) {
        if (userAnswers[currentIndex]) return;

        const q = currentPool[currentIndex];
        const isCorrect = (selected === q.answer);
        
        userAnswers[currentIndex] = { selected, isCorrect, questionObj: q };

        // Ä°statistik Kaydet
        updateQuestionStats(q, isCorrect);

        // UI GÃ¼ncelle
        applyFeedback();
        updateDots();

        // Otomatik GeÃ§iÅŸ (DÃ¼zeltildi)
        // TÃ¼m ÅŸÄ±klara tÄ±klamayÄ± engelle (Ã‡ift tÄ±klama sorunu iÃ§in)
        const allOpts = document.querySelectorAll('.option-card');
        allOpts.forEach(o => o.style.pointerEvents = 'none');

        if (document.getElementById('auto-next').checked && isCorrect) {
            setTimeout(() => {
                // EÄŸer hala aynÄ± sorudaysak (kullanÄ±cÄ± manuel geÃ§mediyse) geÃ§
                if (currentIndex < currentPool.length - 1) nextQuestion();
                else finishQuiz();
            }, 700); // 700ms bekleme
        }
    }

    function applyFeedback() {
        const ans = userAnswers[currentIndex];
        if (!ans) return;
        
        const q = currentPool[currentIndex];
        const opts = document.querySelectorAll('.option-card');
        
        opts.forEach(btn => {
            btn.style.pointerEvents = 'none';
            if (btn.textContent === q.answer) {
                btn.classList.add(ans.isCorrect ? 'correct' : 'hint');
            }
            if (btn.textContent === ans.selected && !ans.isCorrect) {
                btn.classList.add('incorrect');
            }
        });
    }

    function restoreState() { applyFeedback(); }

    // Navigasyon
    function nextQuestion() {
        if (currentIndex < currentPool.length - 1) {
            currentIndex++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    function prevQuestion() {
        if (currentIndex > 0) {
            currentIndex--;
            loadQuestion();
        }
    }

    function endQuiz() {
        if(confirm("Testi sonlandÄ±rmak istiyor musunuz?")) showPage('page-menu');
    }

    function updateProgressBar() {
        const percent = ((currentIndex + 1) / currentPool.length) * 100;
        document.getElementById('q-bar').style.width = `${percent}%`;
    }

    function renderDots() {
        const div = document.getElementById('q-dots');
        div.innerHTML = '';
        currentPool.forEach((_, i) => {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.textContent = i + 1;
            if (i === currentIndex) dot.classList.add('current');
            if (userAnswers[i]) dot.classList.add(userAnswers[i].isCorrect ? 'correct' : 'incorrect');
            dot.onclick = () => { currentIndex = i; loadQuestion(); };
            div.appendChild(dot);
        });
    }

    function finishQuiz() {
        const correct = userAnswers.filter(a => a && a.isCorrect).length;
        const score = Math.round((correct / currentPool.length) * 100);
        
        document.getElementById('res-score').textContent = `%${score}`;
        const msg = document.getElementById('res-msg');
        
        if (score >= 90) msg.textContent = "MÃ¼kemmel! ğŸš€";
        else if (score >= 70) msg.textContent = "Gayet Ä°yi! ğŸ‘";
        else msg.textContent = "Biraz Daha Tekrar Gerekli. ğŸ§";

        // YanlÄ±ÅŸlarÄ± Bul ve Butonu GÃ¶ster/Gizle
        const wrongAnswers = userAnswers.filter(a => !a.isCorrect);
        const retryBtn = document.getElementById('btn-retry-session-mistakes');
        
        if (wrongAnswers.length > 0) {
            retryBtn.style.display = 'block';
            retryBtn.textContent = `âš ï¸ Bu Testteki ${wrongAnswers.length} YanlÄ±ÅŸÄ± Ã‡Ã¶z`;
        } else {
            retryBtn.style.display = 'none';
        }

        showPage('page-result');
    }

    function restartQuiz() {
        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

    // Sadece O Anki Testteki YanlÄ±ÅŸlarÄ± Tekrar Ã‡Ã¶z
    function retrySessionMistakes() {
        const wrongQuestions = userAnswers
            .filter(a => !a.isCorrect)
            .map(a => a.questionObj);
            
        if(wrongQuestions.length === 0) return;

        currentPool = wrongQuestions;
        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

</script>
</body>
</html>
