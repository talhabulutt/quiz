<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HavacÄ±lÄ±k & AOF SÄ±nav Sistemi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #22c55e;
            --danger: #dc2626;
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text-main: #1e293b;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .app-container {
            background: var(--card);
            width: 100%;
            max-width: 900px;
            min-height: 780px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* SAYFA GEÃ‡Ä°ÅLERÄ° */
        .page {
            display: none;
            flex-grow: 1;
            padding: 30px;
            flex-direction: column;
            animation: fadeIn 0.3s ease-out;
        }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* LOGIN */
        .login-wrapper { margin: auto; text-align: center; width: 100%; max-width: 400px; }
        .login-input {
            width: 100%; padding: 16px; border-radius: 8px; border: 2px solid var(--border);
            background: #f8fafc; font-size: 1.1rem; margin-bottom: 20px; text-align: center;
        }
        .login-input:focus { border-color: var(--primary); outline: none; background: #fff; }

        /* BUTONLAR */
        .btn {
            background: white; border: 2px solid var(--border); color: #334155;
            padding: 14px; border-radius: 8px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); color: white; border-color: var(--primary-dark); }
        .btn-danger { background: #fee2e2; color: var(--danger); border-color: #fecaca; }
        .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .grid-menu { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }

        /* HEADER & USER */
        .user-header {
            position: absolute; top: 20px; right: 20px; z-index: 10;
            display: flex; align-items: center; gap: 15px;
            font-size: 0.9rem; color: var(--secondary);
            background: rgba(255,255,255,0.95); padding: 6px 16px; border-radius: 20px; border: 1px solid var(--border);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .logout-link { color: var(--danger); cursor: pointer; font-weight: 600; }

        /* --- ANA MENÃœ HATA ANALÄ°Z KARTI --- */
        .stats-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        .stats-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .stats-title { font-size: 0.95rem; color: var(--text-main); font-weight: 700; text-transform: uppercase; }
        
        /* Sekmeler (Tabs) */
        .stats-tabs {
            display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px;
        }
        .stat-tab {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; cursor: pointer;
            border: 1px solid var(--border); background: white; color: var(--secondary); white-space: nowrap;
            transition: all 0.2s;
        }
        .stat-tab.active {
            background: var(--primary); color: white; border-color: var(--primary);
        }
        .stat-tab:hover:not(.active) { background: #e2e8f0; }

        /* --- QUIZ ALANI --- */
        .quiz-row-1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .quiz-user-badge { font-size: 0.9rem; font-weight: 600; color: var(--primary); background: #eff6ff; padding: 5px 12px; border-radius: 15px; }

        .quiz-row-2 { margin-bottom: 15px; }
        .progress-container { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        .quiz-row-3 { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .question-counter { font-weight: 700; color: var(--secondary); font-size: 1rem; }

        .question-text { font-size: 1.3rem; font-weight: 700; color: var(--text-main); margin-bottom: 25px; line-height: 1.6; }
        
        .option-card {
            padding: 18px; border: 2px solid var(--border); border-radius: 10px;
            cursor: pointer; transition: 0.2s; font-size: 1.05rem; margin-bottom: 10px;
            background: white; color: #334155; position: relative;
        }
        .option-card:hover { border-color: #94a3b8; background: #f1f5f9; }
        .option-card.correct { background: #dcfce7; border-color: var(--success); color: #14532d; font-weight: 600; }
        .option-card.incorrect { background: #fee2e2; border-color: var(--danger); color: #7f1d1d; }
        .option-card.hint { border-color: var(--success); background: #f0fdf4; color: var(--success); font-weight: 600; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 25px; gap: 15px; }
        .nav-btn { flex: 1; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; font-size: 1rem; }
        .btn-prev { background: #e2e8f0; color: #475569; }
        .btn-next { background: var(--primary-dark); color: white; }

        .fast-access-container { margin-top: auto; border-top: 1px solid var(--border); padding-top: 20px; }
        .fast-access-title { text-align: center; font-size: 0.85rem; color: var(--secondary); margin-bottom: 10px; }
        .access-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); gap: 6px; max-height: 150px; overflow-y: auto; padding: 5px; }
        .access-btn {
            height: 35px; display: flex; align-items: center; justify-content: center;
            background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px;
            font-size: 0.85rem; font-weight: 500; color: #64748b; cursor: pointer; transition: all 0.1s;
        }
        .access-btn:hover { background: #e2e8f0; }
        .access-btn.current { border: 2px solid #0f172a; color: #0f172a; font-weight: 800; background: white; transform: scale(1.05); }
        .access-btn.correct { background: var(--success); color: white; border-color: var(--success); }
        .access-btn.incorrect { background: var(--danger); color: white; border-color: var(--danger); }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { display:none; }
        .slider { position: absolute; cursor: pointer; top:0; left:0; right:0; bottom:0; background-color: #cbd5e1; transition:.3s; border-radius: 34px; }
        .slider:before { position: absolute; content:""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition:.3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }
        .switch-label { font-size: 0.9rem; color: var(--secondary); font-weight: 600; margin-right: 10px; }

        .score-circle {
            width: 150px; height: 150px; border-radius: 50%; background: transparent;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            margin: 0 auto 20px; font-size: 2.2rem; font-weight: 800; color: var(--text-main); border: 10px solid #e2e8f0;
        }
        .score-circle.good { border-color: var(--success); color: var(--success); }
        .score-circle.bad { border-color: var(--danger); color: var(--danger); }
        .score-label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #64748b; margin-top: 5px; }

        .access-grid::-webkit-scrollbar { width: 6px; }
        .access-grid::-webkit-scrollbar-track { background: #f1f1f1; }
        .access-grid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body>

<div class="app-container">
    
    <div id="user-info-panel" class="user-header" style="display: none;">
        <span>ğŸ‘¤ <b id="display-username">Misafir</b></span>
        <span class="logout-link" onclick="logout()">Ã‡Ä±kÄ±ÅŸ</span>
    </div>

    <div id="page-login" class="page active">
        <div class="login-wrapper">
            <h1 style="color: var(--primary); margin-bottom: 10px;">SÄ±nav Sistemi</h1>
            <p style="color: var(--secondary); margin-bottom: 30px;">GiriÅŸ YapÄ±n</p>
            <input type="text" id="username-input" class="login-input" placeholder="AdÄ±nÄ±z">
            <button class="btn btn-primary" style="width:100%" onclick="login()">GiriÅŸ Yap</button>
        </div>
    </div>

    <div id="page-menu" class="page">
        <h2 style="color: #1e293b; margin-bottom: 20px;">Ana MenÃ¼</h2>
        <div class="grid-menu">
            <button class="btn" onclick="startQuiz('temel')">âœˆï¸ Temel Sorular (102)</button>
            <button class="btn" onclick="startQuiz('cikmis')">ğŸ“œ Ã‡Ä±kmÄ±ÅŸ Sorular (48)</button>
            <button class="btn" onclick="startQuiz('ai')">ğŸ¤– AI Ã–ÄŸretici (40)</button>
        </div>
        <button class="btn btn-primary" style="margin-bottom: 20px;" onclick="showPage('page-aof')">ğŸ“š AOF ModÃ¼lÃ¼ (Deneme/Final)</button>
        
        <div class="stats-card">
            <div class="stats-header">
                <div class="stats-title">ğŸ“Š HATA ANALÄ°ZÄ°</div>
            </div>
            
            <div class="stats-tabs">
                <div class="stat-tab active" onclick="switchMistakeTab('all', this)">GENEL</div>
                <div class="stat-tab" onclick="switchMistakeTab('temel', this)">TEMEL</div>
                <div class="stat-tab" onclick="switchMistakeTab('cikmis', this)">Ã‡IKMIÅ</div>
                <div class="stat-tab" onclick="switchMistakeTab('ai', this)">AI</div>
                <div class="stat-tab" onclick="switchMistakeTab('aof', this)">AOF</div>
            </div>

            <div id="mistake-stats" style="display:flex; gap:10px; flex-wrap:wrap; min-height: 50px; align-items: center;">
                <span style="color:#94a3b8; font-size:0.9rem;">YÃ¼kleniyor...</span>
            </div>
        </div>

        <button class="btn" style="width: 100%;" onclick="startQuiz('mix')">ğŸ”€ TÃ¼mÃ¼nÃ¼ KarÄ±ÅŸtÄ±r</button>
    </div>

    <div id="page-aof" class="page">
        <button class="btn" style="width: auto; align-self: flex-start; margin-bottom: 20px;" onclick="showPage('page-menu')">â† Geri</button>
        <h2 style="margin-bottom: 20px;">AOF SÄ±navlarÄ±</h2>
        <div class="grid-menu">
            <button class="btn" onclick="startQuiz('aof_deneme1')">ğŸ“ Deneme 1</button>
            <button class="btn" onclick="startQuiz('aof_deneme2')">ğŸ“ Deneme 2</button>
            <button class="btn" onclick="startQuiz('aof_final1')">ğŸ“ Final 1</button>
            <button class="btn" onclick="startQuiz('aof_final2')">ğŸ“ Final 2</button>
        </div>
        <button class="btn btn-primary" style="margin-top: 10px;" onclick="startQuiz('aof_mix')">ğŸ”€ KarÄ±ÅŸÄ±k AOF Testi</button>
    </div>

    <div id="page-quiz" class="page">
        <div class="quiz-row-1">
            <button onclick="endQuiz()" style="background:none; border:none; color:#94a3b8; font-weight:bold; cursor:pointer; font-size: 0.9rem;">âœ• Testten Ã‡Ä±k</button>
            <div class="quiz-user-badge">ğŸ‘¤ <span id="display-username-quiz">KullanÄ±cÄ±</span></div>
        </div>
        <div class="quiz-row-2">
            <div class="progress-container"><div class="progress-fill" id="q-progress"></div></div>
        </div>
        <div class="quiz-row-3">
            <span class="question-counter" id="q-counter">Soru 1/10</span>
            <div style="display:flex; align-items:center;">
                <span class="switch-label">Otomatik GeÃ§</span>
                <label class="switch">
                    <input type="checkbox" id="auto-next" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <div class="question-text" id="q-text">YÃ¼kleniyor...</div>
        <div id="q-options"></div>

        <div class="nav-buttons">
            <button class="nav-btn btn-prev" id="btn-prev" onclick="prevQuestion()">â† Ã–nceki</button>
            <button class="nav-btn btn-next" id="btn-next" onclick="nextQuestion()">Sonraki â†’</button>
        </div>

        <div class="fast-access-container">
            <div class="fast-access-title">HÄ±zlÄ± EriÅŸim</div>
            <div class="access-grid" id="fast-access-grid"></div>
        </div>
    </div>

    <div id="page-result" class="page">
        <div style="margin: auto; text-align: center;">
            <div class="score-circle" id="result-circle">
                <span id="res-score">%0</span>
                <span class="score-label">BAÅARI</span>
            </div>
            <h2 id="res-msg">SonuÃ§</h2>
            <p style="color:var(--secondary); margin-bottom:30px;">SonuÃ§lar analiz edildi.</p>
            <div style="display:flex; flex-direction:column; gap:15px; max-width:400px; margin:0 auto;">
                <button id="btn-retry-session" class="btn btn-danger" style="display:none;" onclick="retrySessionMistakes()">âš ï¸ Bu Testteki YanlÄ±ÅŸlarÄ± Ã‡Ã¶z</button>
                <button class="btn btn-primary" onclick="restartQuiz()">ğŸ”„ AynÄ± Testi Tekrarla</button>
                <button class="btn" onclick="showPage('page-menu')">ğŸ  Ana MenÃ¼</button>
            </div>
        </div>
    </div>

</div>

<script>
    /* --- 1. VERÄ° HAVUZLARI --- */
    
    // TEMEL SORULAR
    const basicQuestions = [
        { q: "HavacÄ±lÄ±k faaliyetleri kaÃ§a ayrÄ±lÄ±r?", options: ["ÃœÃ§e", "Ä°kiye", "DÃ¶rde", "BeÅŸe"], answer: "Ä°kiye" },
        { q: "Devlet hava araÃ§larÄ± nelerdir?", options: ["AskerÃ®, gÃ¼mrÃ¼k, polis", "Yolcu, kargo, eÄŸitim", "TarÄ±m, balon, planÃ¶r", "Helikopter, jet, planÃ¶r"], answer: "AskerÃ®, gÃ¼mrÃ¼k, polis" },
        { q: "1 foot kaÃ§ metredir?", options: ["0,25", "0,3048", "1,85", "3,048"], answer: "0,3048" }
        // ... (Buraya diÄŸer 102 soruyu yapÄ±ÅŸtÄ±rÄ±n)
    ];
    
    // Ã‡IKMIÅ SORULAR
    const pastQuestions = [
        { q: "ICAO KodlarÄ±na GÃ¶re HavaalanlarÄ± Ã¼lkemizde hangi harf ile baÅŸlamaktadÄ±r?", options: ["L", "T", "E", "A"], answer: "L" },
        { q: "BakÄ±mÄ±n yapÄ±ldÄ±ÄŸÄ± yere gÃ¶re bakÄ±m tÃ¼rleri nelerdir?", options: ["Hat BakÄ±mÄ±, Ãœs BakÄ±mÄ±", "Ã–nleyici, DÃ¼zeltici", "PlanlÄ±, PlansÄ±z", "AÄŸÄ±r, Hafif"], answer: "Hat BakÄ±mÄ±, Ãœs BakÄ±mÄ±" }
        // ... (Buraya diÄŸer Ã§Ä±kmÄ±ÅŸ sorularÄ± yapÄ±ÅŸtÄ±rÄ±n)
    ];

    // AI SORULARI
    const aiQuestions = [
        { q: "ICAO Annex 17 (Ek-17) hangi konuyu dÃ¼zenler?", options: ["Hava Trafik", "GÃ¼venlik (Security)", "Ã‡evre", "Arama Kurtarma"], answer: "GÃ¼venlik (Security)" }
        // ... (Buraya diÄŸer AI sorularÄ± yapÄ±ÅŸtÄ±rÄ±n)
    ];

    // AOF SorularÄ± (FORMATLI)
    const aofData = {
        deneme1: [
            { 
                q: "AÅŸaÄŸÄ±da verilenlerden hangileri dÃ¼ÅŸÃ¼k maliyetli havayolu iÅŸletmelerinin Ã¶zelliklerindendir?<br><br>I. Yolcuya yÃ¶nelik kÄ±sÄ±tlÄ± hizmet ve dÃ¼ÅŸÃ¼k konfor sunarlar.<br>II. YolcularÄ±nÄ± genellikle noktadan noktaya taÅŸÄ±rlar.<br>III. UÃ§uÅŸlarÄ±nÄ± uzun mesafeli hatlarda gerÃ§ekleÅŸtirirler.<br>IV. OlabildiÄŸince bÃ¶lgesel ve ikincil havaalanlarÄ±nÄ± kullanÄ±rlar.", 
                options: ["YalnÄ±z I", "II ve III", "YalnÄ±z IV", "I, II ve IV", "I, II, III ve IV"], 
                answer: "I, II ve IV" 
            },
            { q: "AÅŸaÄŸÄ±daki kategorilerden hangisine sahip olan bir hava aracÄ± bakÄ±m personeli; bir uÃ§aÄŸÄ±n tamamÄ± Ã¼zerinde gerÃ§ekleÅŸtirilen Ã¼s bakÄ±mÄ± sonrasÄ±nda bakÄ±m Ã§Ä±kÄ±ÅŸ sertifikasÄ± dÃ¼zenleme yetkisine sahiptir?", options: ["A", "B1", "B2", "B3", "C"], answer: "C" },
            { q: "HÄ±zlanan akÄ±ÅŸkanÄ±n basÄ±ncÄ±nÄ±n dÃ¼ÅŸeceÄŸini veya yavaÅŸlayan akÄ±ÅŸkanÄ±n basÄ±ncÄ±nÄ±n artacaÄŸÄ±nÄ±, ya da basÄ±ncÄ± azalan akÄ±ÅŸkanÄ±n hÄ±zlanacaÄŸÄ±nÄ±, veya basÄ±ncÄ± artan akÄ±ÅŸkanÄ±n yavaÅŸlayacaÄŸÄ±nÄ±, kÃ¼tle ve enerjinin korunumu prensiplerine aÃ§Ä±klayan fizik kanunu aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["Newtonâ€™un Birinci Hareket Kanunu", "Newtonâ€™un Ä°kinci Hareket Kanunu", "Newtonâ€™un ÃœÃ§Ã¼ncÃ¼ Hareket Kanunu", "Barnoulli Prensibi", "ArÅŸimed Prensibi"], answer: "Barnoulli Prensibi" },
            { q: "Bir hava aracÄ± bakÄ±m personeli hava aracÄ± Ã¼zerinde planlÄ± kÃ¼Ã§Ã¼k hat bakÄ±m ve basit arÄ±za giderme iÅŸlemleri yapabiliyorsa bu hava aracÄ± bakÄ±m personeli aÅŸaÄŸÄ±daki kategorilerden hangisine dahildir?", options: ["B1", "A", "B2", "B3", "C"], answer: "A" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi Bernoulli prensibini en doÄŸru aÃ§Ä±klar?", options: ["Hareket hÃ¢lindeki akÄ±ÅŸkanlarÄ±n basÄ±ncÄ± ve hÄ±zlarÄ± arasÄ±nda ters orantÄ± vardÄ±r.", "HÄ±zlanan akÄ±ÅŸkanÄ±n basÄ±ncÄ± aynÄ± oranda artar.", "Bir cismin momentumunda meydana gelen deÄŸiÅŸim, cisim Ã¼zerine etkiyen dÄ±ÅŸ kuvvete eÅŸittir.", "Her kuvvete karÅŸÄ± eÅŸit bÃ¼yÃ¼klÃ¼kte ve zÄ±t yÃ¶nde bir kuvvet etkir.", "Bir cismin Ã¼zerine etkiyen kuvvetlerin toplamÄ± sÄ±fÄ±rdan farklÄ± ise duran cisim harekete geÃ§er."], answer: "Hareket hÃ¢lindeki akÄ±ÅŸkanlarÄ±n basÄ±ncÄ± ve hÄ±zlarÄ± arasÄ±nda ters orantÄ± vardÄ±r." },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi uÃ§uÅŸ planlamasÄ± yapar ve uÃ§uÅŸ sÃ¼resince uÃ§uÅŸu izler, uÃ§uÅŸ sÄ±rasÄ±nda hava aracÄ±nda bulunan sorumlu pilot ile irtibat hÃ¢linde bulunur?", options: ["UÃ§uÅŸ ekibi", "Hava aracÄ± bakÄ±m personeli", "UÃ§uÅŸ harekÃ¢t uzmanÄ±", "Hava trafik emniyeti elektronik personeli", "Hava trafik kontrolÃ¶rÃ¼"], answer: "UÃ§uÅŸ harekÃ¢t uzmanÄ±" },
            { q: "Havayolu iÅŸletmesi tarafÄ±ndan yolcu ve yÃ¼k taÅŸÄ±mak Ã¼zere arz edilen koltuk kapasitesinin ton olarak eÅŸ deÄŸeri ile kargo kapasitesinin toplamÄ±nÄ±n bunlarÄ±n uÃ§urulduÄŸu mesafeyle Ã§arpÄ±mÄ±na eÅŸit olan yapÄ±lan iÅŸ deÄŸerine ne ad verilir?", options: ["Arz Edilen Koltuk-kilometre", "Ãœcretli Yolcu- kilometre", "Yolcu Doluluk OranÄ±", "Arz Edilen Ton- Kilometre", "Ãœcretli Ton- Kilometre"], answer: "Arz Edilen Ton- Kilometre" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi bir tÃ¼rbojet motorunun alt elemanlarÄ±ndan biri deÄŸildir?", options: ["KompresÃ¶r", "Yanma odasÄ±", "Pervane", "TÃ¼rbin", "Egzoz"], answer: "Pervane" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi uÃ§ak Ã¼zerine etki eden dÃ¶rt temel kuvvetten biri deÄŸildir?", options: ["AÄŸÄ±rlÄ±k", "Frenleme", "SÃ¼rÃ¼kleme", "Ä°tme", "TaÅŸÄ±ma"], answer: "Frenleme" },
            { q: "AÅŸaÄŸÄ±daki seÃ§eneklerden hangisi havadan aÄŸÄ±r motorlu hava araÃ§larÄ±ndan birisi deÄŸildir?", options: ["Hava Gemisi", "Helikopter", "Otocayro", "UÃ§ak", "Amfibik UÃ§ak"], answer: "Hava Gemisi" },
            { q: "TÃ¼rkiye Ticari Hava TaÅŸÄ±ma Ä°ÅŸletmeleri YÃ¶netmeliÄŸiâ€™ne gÃ¶re Ã§alÄ±ÅŸan hava taksi iÅŸletmelerinin uÃ§aklarÄ±nÄ±n sahip olabileceÄŸi en fazla koltuk sayÄ±sÄ± aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["14", "16", "19", "20", "22"], answer: "19" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi bir bakÄ±m kuruluÅŸunun temelde ilgilendiÄŸi konulardan biri deÄŸildir?", options: ["Hava aracÄ± ve komponetlerin iÅŸletilmesi", "HavacÄ±lÄ±k kurallarÄ± ve mevzuatÄ±", "Hava aracÄ± bakÄ±mÄ± iÃ§in emniyet standartlarÄ±", "Ticari hava aracÄ± lisanslarÄ±nÄ±n sorgulanmasÄ±", "Hava aracÄ± ve iÅŸÃ§ilik iÃ§in en yÃ¼ksek Ã¼rretkenliÄŸe ulaÅŸÄ±lmasÄ±"], answer: "Ticari hava aracÄ± lisanslarÄ±nÄ±n sorgulanmasÄ±" },
            { q: "Hava aracÄ± Ã¼zerinde gerÃ§ekleÅŸtirilen Ã¼s bakÄ±mÄ± sonrasÄ±nda bakÄ±m Ã§Ä±kÄ±ÅŸ sertifikasÄ± dÃ¼zenleme yetkisine sahip uÃ§ak bakÄ±m personeli hangi kategoridedir?", options: ["A kategorisinde", "B1 kategorisinde", "B2 kategorisinde", "B3 kategorisinde", "C kategorisinde"], answer: "C kategorisinde" },
            { q: "AÅŸaÄŸÄ±daki ulusal havacÄ±lÄ±k mevzuatlarÄ±ndan hangisinin yÃ¶netmelik maddesi ile aÃ§Ä±klamasÄ± yanlÄ±ÅŸ eÅŸleÅŸtirilmiÅŸtir?", options: ["SHY-M SÃ¼rekli uÃ§uÅŸa elveriÅŸlilik bakÄ±m sorumluluÄŸu yÃ¶netmeliÄŸi", "SHY-66 Hava aracÄ± bakÄ±m personeli lisans yÃ¶netmeliÄŸi", "SHY-147 Sivil havacÄ±lÄ±k gÃ¼venliÄŸi eÄŸitim ve sertifikasyon talimatÄ±", "SHY-SMS Sivil havacÄ±lÄ±kta emniyet yÃ¶netimi yÃ¶netmeliÄŸi", "SHT-TEDARÄ°K OnaylÄ± tedarikÃ§i kuruluÅŸlarÄ± talimatÄ±"], answer: "SHY-147 Sivil havacÄ±lÄ±k gÃ¼venliÄŸi eÄŸitim ve sertifikasyon talimatÄ±" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisinde mach sayÄ±sÄ±nÄ±n formÃ¼lÃ¼ze edilmiÅŸ hali doÄŸru olarak verilmiÅŸtir?", options: ["M=C/V=uÃ§aÄŸÄ±n hava hÄ±zÄ±/ses hÄ±zÄ±", "M=C/V=ses hÄ±zÄ±/uÃ§aÄŸÄ±n hava hÄ±zÄ±", "M=V/C=ses hÄ±zÄ±/uÃ§aÄŸÄ±n hava hÄ±zÄ±", "M=V/C=uÃ§aÄŸÄ±n hava hÄ±zÄ±/ses hÄ±zÄ±", "M=V/C=uÃ§aÄŸÄ±n hava hÄ±zÄ± X ses hÄ±zÄ±"], answer: "M=V/C=uÃ§aÄŸÄ±n hava hÄ±zÄ±/ses hÄ±zÄ±" },
            { q: "BakÄ±m maliyetleri ile ilgili aÅŸaÄŸÄ±daki ifadelerden hangisi doÄŸrudur?", options: ["BakÄ±m maliyetleri, havayolu iÅŸletme maliyetlerinin %40â€™Ä±nÄ± oluÅŸturmaktadÄ±r", "BakÄ±m maliyetleri dolaylÄ± iÅŸletme maliyetleri iÃ§erinde yer almaktadÄ±r", "BakÄ±m maliyetleri dolaylÄ± iÅŸletme maliyetlerinin %30â€™unu oluÅŸturmaktadÄ±r", "Filonun bÃ¼yÃ¼klÃ¼ÄŸÃ¼ ve Ã§eÅŸitliliÄŸi bakÄ±m maliyetlerini etkilemektedir", "Servis bÃ¼ltenleri bakÄ±m maliyetlerini etkilemez"], answer: "Filonun bÃ¼yÃ¼klÃ¼ÄŸÃ¼ ve Ã§eÅŸitliliÄŸi bakÄ±m maliyetlerini etkilemektedir" },
            { q: "YayÄ±mlanmÄ±ÅŸ bir zaman tablosuna gÃ¶re belli ve dÃ¼zenli aralÄ±klarla sistematik olarak gerÃ§ekleÅŸtirilen uÃ§uÅŸlara verilen ad aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["Tarifesiz sefer", "Check in", "Tarifeli sefer", "Ãœcretli yolcu seferleri", "Hava taksi"], answer: "Tarifeli sefer" },
            { q: "DÃ¼nyaâ€™nÄ±n ilk ticari hava yolu iÅŸletmesi aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["AIR CANADA", "HAINAN AIRLINES", "DELAG", "AIR NEW ZEALAND", "KOREAN AIR"], answer: "DELAG" },
            { q: "AÅŸaÄŸÄ±daki seÃ§eneklerden hangisi hava iÅŸi kapsamÄ±nda deÄŸerlendirilen faaliyetlerden birisi deÄŸildir?", options: ["ParaÅŸÃ¼t atma", "Arama kurtarma, afet yardÄ±m", "Havadan pano Ã§ekimi", "Hava taksi", "Zirai ilaÃ§lama"], answer: "Hava taksi" },
            { q: "â€¦................... hava aracÄ±ndan sÃ¶kÃ¼len komponentlerin tamir, yenileme ve test iÅŸlemlerini kapsar. CÃ¼mledeki boÅŸluÄŸa hangisi gelmelidir?", options: ["Destek BakÄ±m", "Ã–nleyici BakÄ±m", "DÃ¼zeltici BakÄ±m", "AtÃ¶lye BakÄ±m", "BÃ¼yÃ¼k BakÄ±m"], answer: "AtÃ¶lye BakÄ±m" }
        ],
        deneme2: [
            { q: "Havayolu iÅŸletmesi tarafÄ±ndan Ã¼cretli yolcu taÅŸÄ±mak Ã¼zere arz edilen koltuk sayÄ±sÄ± ile bu koltuk sayÄ±sÄ±nÄ±n uÃ§urulduÄŸu mesafenin Ã§arpÄ±mÄ±na eÅŸit olan yapÄ±lan iÅŸ deÄŸerine ne ad verilir?", options: ["Arz Edilen Koltuk-kilometre", "Ãœcretli Yolcu- kilometre", "Yolcu Doluluk OranÄ±", "Arz Edilen Ton- Kilometre", "Ãœcretli Ton- Kilometre"], answer: "Arz Edilen Koltuk-kilometre" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi havacÄ±lÄ±k mesleÄŸini icra etmek Ã¼zere yetkilendirilmiÅŸ kiÅŸilerden biri deÄŸildir?", options: ["UÃ§uÅŸ Ekibi", "Hava Trafik KontrolÃ¶rÃ¼", "Hava Trafik Emniyeti Elektronik Personeli", "UÃ§uÅŸ HarekÃ¢t UzmanÄ±", "HavaalanÄ± GÃ¼venlik Personeli"], answer: "HavaalanÄ± GÃ¼venlik Personeli" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi, ICAO tarafÄ±ndan yayÄ±nlanmÄ±ÅŸ olan Ek-6 Hava AracÄ±nÄ±n Ä°ÅŸletilmesi dÃ¶kÃ¼manÄ±nda, bir iÅŸleticinin bakÄ±m ile ilgili sorumluluklarÄ±ndan biri deÄŸildir?", options: ["BakÄ±m Ã§Ä±kÄ±ÅŸÄ±nÄ± imzalayacak kiÅŸinin Ek-1â€™e gÃ¶re lisanslÄ± olmasÄ± gerekir.", "Ä°ÅŸleticiler, hava araÃ§larÄ±nÄ±n bakÄ±mlarÄ±nÄ±n bakÄ±m programÄ±na gÃ¶re yapÄ±lmasÄ±nÄ± saÄŸlamalÄ±dÄ±rlar.", "UÃ§uÅŸ maliyetlerinin minimumda tutulmasÄ±nÄ± saÄŸlamalÄ±dÄ±r.", "Ä°ÅŸlettikleri tÃ¼m hava araÃ§larÄ±nÄ±n uÃ§uÅŸa elveriÅŸlilik sertifikalarÄ±nÄ±n geÃ§erliliÄŸini korumasÄ±nÄ± saÄŸlamalÄ±dÄ±r.", "Ä°ÅŸlettikleri hava araÃ§larÄ±nÄ±n uÃ§uÅŸa elveriÅŸli bir durumda tutulmasÄ±nÄ± saÄŸlamalÄ±dÄ±r."], answer: "UÃ§uÅŸ maliyetlerinin minimumda tutulmasÄ±nÄ± saÄŸlamalÄ±dÄ±r." },
            { q: "HavacÄ±lÄ±k tarihinde ilk TÃ¼rk yolcu uÃ§aÄŸÄ±nÄ± kim yapmÄ±ÅŸtÄ±r?", options: ["Vecihi HÃ¼rkuÅŸ", "Sabiha GÃ¶kÃ§en", "Fesa Bey", "Nuri DemiraÄŸ", "Kenan Bey"], answer: "Nuri DemiraÄŸ" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisi istenmeyen bir durumun oluÅŸma olasÄ±lÄ±ÄŸÄ±nÄ± niteleyen terimdir?", options: ["Emniyetsizlik", "Tehlike", "Risk", "GÃ¼vensizlik", "FaydasÄ±zlÄ±k"], answer: "Risk" },
            { q: "Aviyonik ve elektrik sistemleri Ã¼zerinde bakÄ±m yapan personelin kategorisi aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["B1", "A", "B3", "B2", "C"], answer: "B2" },
            { q: "AÅŸaÄŸÄ±dakilerden hangisinde TÃ¼rkiyeâ€™deki Ticari Hava TaÅŸÄ±ma Ä°ÅŸletmeleri YÃ¶netmeliÄŸi belirtilmiÅŸtir?", options: ["SHY-6B", "SHY-6A", "SHY-6C", "SHY-6D", "SHY-6F"], answer: "SHY-6A" },
            { q: "GeniÅŸ gÃ¶vdeli uÃ§aklarda (bir koridorda) en fazla kaÃ§ koltuk bulunabilmektedir?", options: ["8", "9", "10", "11", "12"], answer: "10" },
            { q: "TÃ¼rkiyeâ€™de Ticari Hava TaÅŸÄ±ma Ä°ÅŸletmeleri YÃ¶netmeliÄŸiâ€™nde (SHY-6A) en fazla on dokuz koltuk kapasitesine sahip uÃ§aklar ile ticari hava taÅŸÄ±macÄ±lÄ±ÄŸÄ± ile yapÄ±lmasÄ± aÅŸaÄŸÄ±dakilerden hangisi ile adlandÄ±rÄ±lmaktadÄ±r?", options: ["BakÄ±m ve OnarÄ±m", "Ticari Hava TaÅŸÄ±macÄ±lÄ±ÄŸÄ±", "Hava Ä°ÅŸi", "Hava Taksi", "Genel HavacÄ±lÄ±k"], answer: "Hava Taksi" },
            { 
                q: "AÅŸaÄŸÄ±daki bakÄ±m iÅŸlerinden hangileri dÃ¼zeltici bakÄ±m iÅŸlemidir?<br><br>I. Filitre deÄŸiÅŸimi<br>II. UÃ§uÅŸ Ã¶ncesi kontroller<br>III. Patlak bir lastiÄŸin deÄŸiÅŸtirilmesi", 
                options: ["Sadece I", "Sadece II", "Sadece III", "I ve II", "I, II ve III"], 
                answer: "Sadece III" 
            },
            { q: "â€¦........... hava aracÄ±nÄ±n veya hava aracÄ± parÃ§asÄ±nÄ±n onaylanmÄ±ÅŸ standartlara uygun olarak hangar gerektirmeyen bakÄ±m, onarÄ±m, parÃ§a deÄŸiÅŸtirme ve hasar giderme iÅŸlemlerinin yapÄ±lmasÄ±nÄ± ifade eder. CÃ¼mledeki boÅŸluÄŸa hangisi gelmelidir?", options: ["Destek BakÄ±m", "Ã–nleyici BakÄ±m", "DÃ¼zeltici BakÄ±m", "Hat BakÄ±m", "BÃ¼yÃ¼k BakÄ±m"], answer: "Hat BakÄ±m" },
            { q: "TarÄ±m, film Ã§ekimi, arama ve kurtarma hizmetleri, elektrik ve boru hatlarÄ±nÄ±n muayenesi, vahÅŸi yaÅŸama dair sayÄ±mlarÄ±n yapÄ±lmasÄ± gibi amaÃ§larla kullanÄ±lan hava araÃ§larÄ± aÅŸaÄŸÄ±dakilerden hangisidir?", options: ["PlanÃ¶r", "Ä°nsansÄ±z hava araÃ§larÄ±", "Genel havacÄ±lÄ±k uÃ§aklarÄ±", "UÃ§urtma", "Ä°ÅŸ uÃ§aÄŸÄ±"], answer: "Ä°nsansÄ±z hava araÃ§larÄ±" },
            { q: "TÃ¼rkiyeâ€™de de havayoluyla ilk resmÃ® posta taÅŸÄ±macÄ±lÄ±ÄŸÄ± hangi yÄ±lda gerÃ§ekleÅŸtirilmiÅŸtir?", options: ["1904", "1910", "1914", "1920", "1924"], answer: "1914" },
            { q: "Kubbe, sepet ve yakÄ±cÄ±lar gibi Ã¼Ã§ ana elemandan oluÅŸan hava aracÄ±na ne ad verilmektedir?", options: ["Balon", "PlanÃ¶r", "Hava gemisi", "Otocayro", "Helikopter"], answer: "Balon" },
            { q: "AÅŸaÄŸÄ±dakilerden hangileri hava balonunun elemanlarÄ±ndan biri deÄŸildir?", options: ["Kubbe", "Yolcular", "YakÄ±cÄ±lar", "Minare", "Pilot"], answer: "Minare" },
            { q: "AÅŸaÄŸÄ±daki seÃ§eneklerden hangisi dÃ¼ÅŸÃ¼k maliyetli havayolu iÅŸletmelerinin Ã¶zelliklerinden birisidir?", options: ["Ã‡ok sayÄ±da personel istihdam ederler", "SÄ±k uÃ§an yolcu programlarÄ± vardÄ±r", "FarklÄ± kabin sÄ±nÄ±flarÄ±nda hizmet sunarlar", "YolcularÄ±nÄ± genellikle noktadan noktaya taÅŸÄ±rlar", "Karma filo yapÄ±sÄ±na sahiptirler"], answer: "YolcularÄ±nÄ± genellikle noktadan noktaya taÅŸÄ±rlar" },
            { q: "Duran bir cismin Ã¼zerine herhangi bir dÄ±ÅŸ kuvvet etki etmedikÃ§e durmasÄ±na devam edeceÄŸini, hareket halinde olan bir cismin de herhangi bir dÄ±ÅŸ kuvvet etki etmedikÃ§e hareketine devam edeceÄŸini ifade eden fizik kanunu hangisidir?", options: ["Newtonâ€™un Birinci Hareket Kanunu", "Newtonâ€™un Ä°kinci Hareket Kanunu", "Newtonâ€™un ÃœÃ§Ã¼ncÃ¼ Hareket Kanunu", "Barnoulli Prensibi", "ArÅŸimed Prensibi"], answer: "Newtonâ€™un Birinci Hareket Kanunu" },
            { 
                q: "DÃ¶ner kanatlÄ± hava araÃ§larÄ± ile ilgili aÅŸaÄŸÄ±daki ifadelerden hangisi yanlÄ±ÅŸtÄ±r?", 
                options: ["Rotor hava aracÄ±nÄ±n motor mili tarafÄ±ndan dÃ¶ndÃ¼rÃ¼len bir ÅŸafta baÄŸlanmÄ±ÅŸ kanat benzeri elemanlardan meydana gelir", "Helikopter, Otocayro ve Cayrodin dÃ¶ner kanatlÄ± hava aracÄ±dÄ±r", "Otocayro havadan aÄŸÄ±r dÃ¶ner kanatlÄ± hava aracÄ±dÄ±r", "Otocayro ve cayrodinâ€™de yatay uÃ§uÅŸ pervane tarafÄ±ndan saÄŸlanmaktadÄ±r", "Helikopterde rotor sadece aracÄ±n havada tutunmasÄ±nÄ± saÄŸlar"], 
                answer: "Helikopterde rotor sadece aracÄ±n havada tutunmasÄ±nÄ± saÄŸlar" 
            },
            { q: "Herhangi bir arÄ±za oluÅŸmadan Ã¶nce yapÄ±lan bakÄ±m iÅŸlemlerine ne ad verilir?", options: ["DÃ¼zeltici bakÄ±m", "Hat bakÄ±m", "Ãœs bakÄ±m", "Ã–nleyici bakÄ±m", "ArÄ±za bakÄ±m"], answer: "Ã–nleyici bakÄ±m" },
            { q: "Havayolu filosundaki bir uÃ§aÄŸÄ±n gidiÅŸ kapÄ±sÄ±ndan hareketinden, varÄ±ÅŸ kapÄ±sÄ±na ulaÅŸÄ±ncaya kadar geÃ§en sÃ¼re aÅŸaÄŸÄ±dakilerden hangisi ile adlandÄ±rÄ±lmaktadÄ±r?", options: ["SeyrÃ¼sefer saat", "Taksi saat", "UÃ§uÅŸ saat", "Blok saat", "YaklaÅŸma saat"], answer: "Blok saat" }
        ],
        final1: [], 
        final2: []
    };

    /* --- 2. SÄ°STEM MANTIÄI --- */

    let currentUser = null;
    let currentPool = [];
    let currentIndex = 0;
    let userAnswers = []; 
    let currentTab = 'all'; // VarsayÄ±lan hata sekmesi

    window.onload = function() {
        const savedUser = localStorage.getItem('havacilik_user');
        if (savedUser) {
            currentUser = savedUser;
            updateUserInfo();
            showPage('page-menu');
            renderMistakeMenu();
        } else {
            showPage('page-login');
        }

        document.getElementById("username-input").addEventListener("keypress", function(event) {
            if (event.key === "Enter") login();
        });

        // Klavye YÃ¶n TuÅŸlarÄ±
        document.addEventListener('keydown', function(event) {
            if (!document.getElementById('page-quiz').classList.contains('active')) return;
            if (event.key === "ArrowLeft") prevQuestion();
            if (event.key === "ArrowRight") nextQuestion();
        });
    };

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        const infoPanel = document.getElementById('user-info-panel');
        if (id === 'page-menu' || id === 'page-aof' || id === 'page-result') {
            infoPanel.style.display = 'flex';
        } else {
            infoPanel.style.display = 'none';
        }

        if(id === 'page-menu') renderMistakeMenu();
    }

    function login() {
        const val = document.getElementById('username-input').value.trim();
        if(!val) return alert("Ä°sim giriniz.");
        currentUser = val;
        localStorage.setItem('havacilik_user', val);
        updateUserInfo();
        showPage('page-menu');
    }

    function logout() {
        if(confirm("Ã‡Ä±kÄ±ÅŸ yapÄ±lsÄ±n mÄ±?")) {
            localStorage.removeItem('havacilik_user');
            currentUser = null;
            showPage('page-login');
        }
    }

    function updateUserInfo() {
        document.getElementById('display-username').textContent = currentUser;
        document.getElementById('display-username-quiz').textContent = currentUser;
    }

    function getDB() { return JSON.parse(localStorage.getItem('havacilik_db_v3') || '{}'); }
    function saveDB(data) { localStorage.setItem('havacilik_db_v3', JSON.stringify(data)); }

    // Sorunun hangi kategoriye ait olduÄŸunu bulur (Hata analizi iÃ§in)
    function findQuestionCategory(qText) {
        // AOF KontrolÃ¼
        for (let key in aofData) {
            if (aofData[key].some(x => x.q === qText)) return 'aof';
        }
        if (basicQuestions.some(x => x.q === qText)) return 'temel';
        if (pastQuestions.some(x => x.q === qText)) return 'cikmis';
        if (aiQuestions.some(x => x.q === qText)) return 'ai';
        return 'other';
    }

    function updateStats(question, isCorrect) {
        let db = getDB();
        if(!db[currentUser]) db[currentUser] = { stats: {} };
        
        const key = question.q;
        if(!db[currentUser].stats[key]) {
            // Kategoriyi ilk kez kaydederken bulup saklÄ±yoruz
            const cat = findQuestionCategory(key);
            db[currentUser].stats[key] = { total: 0, correct: 0, wrong: 0, qObj: question, category: cat };
        }
        
        let stat = db[currentUser].stats[key];
        stat.total++;
        if(isCorrect) stat.correct++; else stat.wrong++;
        stat.qObj = question; // Objenin gÃ¼ncel halini sakla
        
        saveDB(db);
    }

    // Hata MenÃ¼sÃ¼ Sekmeleri ArasÄ± GeÃ§iÅŸ
    function switchMistakeTab(tabName, btn) {
        currentTab = tabName;
        // Buton stillerini gÃ¼ncelle
        document.querySelectorAll('.stat-tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderMistakeMenu();
    }

    function renderMistakeMenu() {
        let db = getDB();
        let stats = db[currentUser] ? db[currentUser].stats : {};
        let critical = [], warning = [], info = [];

        Object.values(stats).forEach(item => {
            // Filtreleme: EÄŸer currentTab 'all' deÄŸilse, sadece o kategoriye ait sorularÄ± al
            if (currentTab !== 'all' && item.category !== currentTab) return;

            if(item.wrong > 0) {
                let rate = (item.correct / item.total) * 100;
                if(rate < 50) critical.push(item.qObj);
                else if(rate < 80) warning.push(item.qObj);
                else info.push(item.qObj);
            }
        });

        const container = document.getElementById('mistake-stats');
        container.innerHTML = '';

        if(critical.length > 0) container.innerHTML += `<button class="btn btn-danger" onclick="startMistakeQuiz('critical')">ğŸ”´ Kritik (${critical.length})</button>`;
        if(warning.length > 0) container.innerHTML += `<button class="btn" style="color:#b45309; border-color:#fcd34d; background:#fffbeb;" onclick="startMistakeQuiz('warning')">ğŸŸ  SÄ±k Hata (${warning.length})</button>`;
        if(info.length > 0) container.innerHTML += `<button class="btn" style="color:#1e40af; border-color:#bfdbfe; background:#eff6ff;" onclick="startMistakeQuiz('info')">ğŸ”µ Nadir (${info.length})</button>`;
        
        if(critical.length===0 && warning.length===0 && info.length===0) container.innerHTML = '<span style="color:#94a3b8;">Bu kategoride hata kaydÄ± yok.</span>';
    }

    function startQuiz(type) {
        let sourceData = [];
        if (type === 'temel') sourceData = basicQuestions;
        else if (type === 'cikmis') sourceData = pastQuestions;
        else if (type === 'ai') sourceData = aiQuestions;
        else if (type === 'mix') sourceData = [...basicQuestions, ...pastQuestions, ...aiQuestions];
        else if (type === 'aof_deneme1') sourceData = aofData.deneme1;
        else if (type === 'aof_deneme2') sourceData = aofData.deneme2;
        else if (type === 'aof_final1') sourceData = aofData.final1;
        else if (type === 'aof_final2') sourceData = aofData.final2;
        else if (type === 'aof_mix') sourceData = [...aofData.deneme1, ...aofData.deneme2, ...aofData.final1, ...aofData.final2];

        if (!sourceData || sourceData.length === 0) return alert("Soru bulunamadÄ±.");
        
        // SorularÄ± ve ÅŸÄ±klarÄ± karÄ±ÅŸtÄ±r
        currentPool = sourceData.map(q => {
            let newQ = { ...q };
            newQ.options = [...q.options].sort(() => Math.random() - 0.5);
            return newQ;
        });

        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

    function startMistakeQuiz(cat) {
        let db = getDB();
        let stats = db[currentUser].stats;
        let pool = [];
        
        Object.values(stats).forEach(item => {
            // Filtre: Kategori + BaÅŸarÄ± OranÄ±
            if (currentTab !== 'all' && item.category !== currentTab) return;

            if(item.wrong > 0) {
                let rate = (item.correct / item.total) * 100;
                if(cat === 'critical' && rate < 50) pool.push(item.qObj);
                if(cat === 'warning' && rate >= 50 && rate < 80) pool.push(item.qObj);
                if(cat === 'info' && rate >= 80) pool.push(item.qObj);
            }
        });
        
        currentPool = pool.map(q => {
            let newQ = { ...q };
            newQ.options = [...q.options].sort(() => Math.random() - 0.5);
            return newQ;
        });

        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

    function initQuizUI() {
        currentIndex = 0;
        userAnswers = new Array(currentPool.length).fill(null);
        showPage('page-quiz');
        loadQuestion();
    }

    function loadQuestion() {
        const q = currentPool[currentIndex];
        
        // .innerHTML ile <br> desteÄŸi saÄŸlandÄ±
        document.getElementById('q-text').innerHTML = `${currentIndex+1}. ${q.q}`;
        
        document.getElementById('q-counter').textContent = `Soru ${currentIndex + 1} / ${currentPool.length}`;
        document.getElementById('q-progress').style.width = `${((currentIndex+1)/currentPool.length)*100}%`;

        const optsDiv = document.getElementById('q-options');
        optsDiv.innerHTML = '';

        q.options.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'option-card';
            btn.textContent = opt;
            btn.onclick = () => handleAnswer(opt, btn);
            optsDiv.appendChild(btn);
        });

        if(userAnswers[currentIndex]) restoreState();
        
        document.getElementById('btn-prev').disabled = (currentIndex === 0);
        document.getElementById('btn-next').textContent = (currentIndex === currentPool.length - 1) ? 'Bitir' : 'Sonraki â†’';
        
        renderFastAccess();
    }

    function handleAnswer(selected, btn) {
        if(userAnswers[currentIndex]) return;

        const q = currentPool[currentIndex];
        const isCorrect = (selected === q.answer);
        
        userAnswers[currentIndex] = { selected, isCorrect, qObj: q };
        
        updateStats(q, isCorrect);
        applyFeedback();
        renderFastAccess();

        const autoNext = document.getElementById('auto-next').checked;
        if(isCorrect && autoNext) {
            const allOpts = document.querySelectorAll('.option-card');
            allOpts.forEach(o => o.style.pointerEvents = 'none');
            
            if (currentIndex < currentPool.length - 1) {
                setTimeout(() => {
                    nextQuestion();
                }, 400); // 0.4 saniye
            }
        }
    }

    function applyFeedback() {
        const ans = userAnswers[currentIndex];
        if(!ans) return;
        
        const q = currentPool[currentIndex];
        const opts = document.querySelectorAll('.option-card');
        
        opts.forEach(btn => {
            btn.style.pointerEvents = 'none';
            if(btn.textContent === q.answer) {
                btn.classList.add(ans.isCorrect ? 'correct' : 'hint');
            }
            if(btn.textContent === ans.selected && !ans.isCorrect) {
                btn.classList.add('incorrect');
            }
        });
    }

    function restoreState() { applyFeedback(); }

    function renderFastAccess() {
        const grid = document.getElementById('fast-access-grid');
        grid.innerHTML = '';
        
        currentPool.forEach((_, i) => {
            const btn = document.createElement('div');
            btn.className = 'access-btn';
            btn.textContent = i + 1;
            
            if (i === currentIndex) btn.classList.add('current');
            
            if (userAnswers[i]) {
                if (userAnswers[i].isCorrect) btn.classList.add('correct');
                else btn.classList.add('incorrect');
            }
            
            btn.onclick = () => {
                currentIndex = i;
                loadQuestion();
            };
            grid.appendChild(btn);
        });
    }

    function nextQuestion() {
        if(currentIndex < currentPool.length - 1) {
            currentIndex++;
            loadQuestion();
        } else {
            finishQuiz();
        }
    }

    function prevQuestion() {
        if(currentIndex > 0) {
            currentIndex--;
            loadQuestion();
        }
    }

    function endQuiz() {
        if(confirm("Testi bitirmek istiyor musunuz?")) showPage('page-menu');
    }

    function finishQuiz() {
        const correct = userAnswers.filter(a => a && a.isCorrect).length;
        const score = Math.round((correct / currentPool.length) * 100);
        
        document.getElementById('res-score').textContent = `%${score}`;
        
        const circle = document.getElementById('result-circle');
        circle.className = 'score-circle'; 
        if(score >= 75) circle.classList.add('good');
        else circle.classList.add('bad');

        const msg = document.getElementById('res-msg');
        if(score >= 90) msg.textContent = "MÃ¼kemmel! ğŸš€";
        else if(score >= 75) msg.textContent = "Tebrikler, GeÃ§tiniz! ğŸ‘";
        else msg.textContent = "Tekrar Gerekli. ğŸ§";

        const wrongOnes = userAnswers.filter(a => a && !a.isCorrect);
        const retryBtn = document.getElementById('btn-retry-session');
        
        if(wrongOnes.length > 0) {
            retryBtn.style.display = 'block';
            retryBtn.textContent = `âš ï¸ Bu Testteki ${wrongOnes.length} YanlÄ±ÅŸÄ± Ã‡Ã¶z`;
        } else {
            retryBtn.style.display = 'none';
        }

        showPage('page-result');
    }

    function restartQuiz() {
        currentPool = currentPool.map(q => {
            let newQ = { ...q };
            newQ.options = [...q.options].sort(() => Math.random() - 0.5);
            return newQ;
        });
        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

    function retrySessionMistakes() {
        const wrongs = userAnswers.filter(a => !a.isCorrect).map(a => a.qObj);
        
        currentPool = wrongs.map(q => {
            let newQ = { ...q };
            newQ.options = [...q.options].sort(() => Math.random() - 0.5);
            return newQ;
        });

        currentPool.sort(() => Math.random() - 0.5);
        initQuizUI();
    }

</script>
</body>
</html>
